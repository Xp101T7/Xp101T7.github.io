---
title: AD Lab Setup
date: 2023-06-29 12:00:00 -500
categories: [Lab,AD]
tags: [Admin,Pentest,AD,7MinSec]


---

> You must do the things you think you cannot do.
> â€” <cite>Eleanor Roosevelt</cite>

---

# AD Pentest Lab 
---

## Installing the WinSrv Eval 

Go to:

https://www.microsoft.com/en-us/evalcenter/

https://www.microsoft.com/en-us/evalcenter/download-windows-server-2022

Download the ISO and Install into proxmox using this Guide. 

[(901) Virtualize Windows 10 with Proxmox VE - YouTube](https://www.youtube.com/watch?v=6c-6xBkD2J4)

[(901) Virtualize Windows 11 with Proxmox the Right Way! - YouTube](https://www.youtube.com/watch?v=fupuTkkKPDU&t=2s)

https://github.com/virtio-win/virtio-win-pkg-scripts/blob/master/README.md

Install Virtio Drivers 

---

## Enable RDP Via PWSH

Snagged this using ChatGPT Plus and some Web Analysis Plugins. (Ask me to learn more!)

To enable Remote Desktop Protocol (RDP) on Windows Server 2022 using PowerShell, you can follow these steps:

1. Run PowerShell as an administrator. You can do this by searching for PowerShell in the Start Menu, right-clicking on it, and selecting "Run as administrator".
    
2. To allow remote connections, type the following command and press Enter:
    

powershellCopy code

`Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0`

3. To make Windows Firewall allow RDP, type the following command and press Enter:

powershellCopy code

`Enable-NetFirewallRule -DisplayGroup "Remote Desktop"`

After running these commands, Remote Desktop should be enabled on your Windows Server 2022 machine. You can then connect to it using a Remote Desktop client.

Please note that you should replace `'HKLM:\System\CurrentControlSet\Control\Terminal Server'` with the actual path of your Terminal Server in the registry if it's different.

Also, remember that enabling Remote Desktop can have security implications, so make sure you have appropriate security measures in place, such as strong passwords and network-level authentication.

Sources:

- [Enable Remote Desktop on Windows Server 2022](https://ln.keymate.ai/0m2euQ)
- [Enable Remote Desktop Via PowerShell](https://ln.keymate.ai/sZRXWy)
- [How to Enable Remote Desktop Protocol (RDP) on Windows](https://ln.keymate.ai/8gVy3I)
  
Once Done Enabling RDP download MobaXTerm.

https://mobaxterm.mobatek.net/download-home-edition.html

---

## Install AD and WindowsFeatures 

```powershell
#Look for the IP of the Host
Write-Host "Find the IPv4 Addr!"
ipconfig /all | findstr IPv4

#Set Value of the RDP Terminal Server Connections to False 0 DenyTSConnection
Write-Host "Enable Terminal Server (RDP)"
Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\" -name "fDenyTSConnections" -value 0

# Open the Win FW
Write-Host "Open the FW for RDP"
Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

# Change local Admin pass
Write-Host "Set super admin pw"
set-localuser -name administrator -password (convertto-securestring "password" -asplaintext -force)

# Get AD Tools
Write-Host "Install AD Domain Services"
Add-WindowsFeature ad-domain-services

# Add forest and name it first setting Secure pass variable to pass into the forest -SafemodeAdminpass string
Write-Host "Install Forest and Set Pass Var!"
$SecurePass = ConvertTo-SecureString -String your-pass-here -AsPlainText -Force

Install-ADDSForest -domainname domain.us -InstallDns -DomainNetbiosName domain.us -SafeModeAdministratorPassword $SecurePassword -force

# Get AD Tools
Write-Host "Install RSAT Tools"
Add-WindowsFeature -name rsat-adds

Write-Host "Open Domain Services Admin"
dsa.msc

# Set pass policy which can be checked in GPO MGMT under default policy settings tab
Write-Host "Set Pass Policy to shitty!"
Set-ADDefaultDomainPasswordPolicy -Identity heckintechin.tech -LockoutThreshold 15 -LockoutDuration 00:03:00 -LockoutObservationWindow 00:02:00 -ComplexityEnabled $false -MaxPasswordAge 180.00:00:00 -MinPasswordAge 1.00:00:00 -MinPasswordLength 6 -PasswordHistoryCount 27

# Check History and get the history file saved to desk
Write-Host "Get history of commands since reboot!"
history

Write-Host "Get history of commands saved to disk after reboot!"
(Get-PSReadlineOption).HistorySavePath

Get-Content (Get-PSReadlineOption).HistorySavePath | Select-String -Pattern "Set-ItemProperty"
```

  ![Pasted image 20230629211545.png](https://raw.githubusercontent.com/Xp101T7/Xp101T7.github.io/main/images/Pasted%20image%2020230629211545.png)

Create GlobalLocalAdmin in GPO Mgmt console under domains > domain. Then navigate via cmd line to the xml file

```Powershell
cd C:\Windows\SYSVOL\domain\Policies\
dir
cd "{D08C90EC-69A4-41AA-A770-CDD0BDC21FA2}"
cd User\Preferences\Groups
dir
```

look for cpassword with encrypted value we can crack this with GP3 finder or gpppfinder 

https://bitbucket.org/grimhacker/gpppfinder/src/master/

	gp3finder -E Mypass

Decrypt 

	gp3finder -D enrcyptedKey

Then paste in the password and then run ping castle

https://pingcastle.com/download/

Start with option 1- HealthCheck-Score the risk of a domain

MS14-025 is still seen in the wild.

[(901) 7MS #556: How to Build a Vulnerable Pentest Lab - YouTube](https://www.youtube.com/watch?v=uQQufyfThdQ&t=2408s)

7 min sec Events
https://7minsec.com/events/live

---

## Check Host Version

Open winver to see host properties...

	winver

---

## Import Bogus Users

https://bpatty.rocks/#!pentesting/lab_setup/index.md

Work has to be done if you use this method in the bpatty rocks server. 

Just find and replace i.got.worms with your AD environment.

Go into PowerShell import script and find the domain and change it. 

OR you can use 

#### Youzer

Fake User Generator for Active Directory Environments
https://github.com/lorentzenman/youzer

ssh into your kali box or a host with python

	sudo python ./youzer.py --generate --generate_length 6 --ou "ou=Contractors,dc=yourdomain,dc=us" --domain domain.us --users 1000 --output lusers.csv

Create a Contractors or other OU on the domain under domain.us > Right Click - New > OU > Name IT 

Create a python web server to serve the files. #note Server defaults to port 8000 unless you specify it like 80 below.


	sudo python3 -m http.server 80

Browse to the IP and pull the files down.

Browse to the file server side and you can see the debugger.

cd to stored users import ps1 script

	Set-ExecutionPolicy bypass

Call the ps1 script let it rip and check the AD OU for the users in ADUC.

---

## Create Roast able Users

Shutoff Windows Defender

Add a folder exclusion on the host where you can download stuff. 

Pull down SharpCollection to the host and save link as to the excluded folder.

https://github.com/Flangvik/SharpCollection

Cracking Active Directory Passwords with AS-REP Roasting
https://blog.netwrix.com/2022/11/03/cracking_ad_password_with_as_rep_roasting/#:~:text=AS%2DREP%20Roasting%20is%20a,then%20attempt%20to%20crack%20offline





  


