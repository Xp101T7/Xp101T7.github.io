---
title: Aurora EDR
date: 2024-03-22 12:00:00 -500
categories: [Aurora,EDR]
tags: [ThreatHunt,Sigma,Aurora,EDR]

---

> [!quote] Ethics change with technology.
> — Larry Niven

---

## Aurora EDR

[Aurora EDR](https://tryhackme.com/room/auroraedr)


Event Tracing for Windows
Event Tracing for Windows (ETW) is a Windows OS logging feature that provides a mechanism to trace and log events raised by user-mode applications and kernel-mode drivers. ETW provides the capability for applications and drivers to write events. For cybersecurity defenders, this becomes a vital source of detection information.

ETW is made up of three distinct parts:

- Controllers: These applications are used to configure event tracing sessions. They also initiate the providers. An example of a Controller is logman.exe.
- Providers: These are the applications that produce event logs.
- Consumers: These applications subscribe and listen to events in real-time or from a file.

he event information is categorised under these types of levels:

- **Information:** Describes the successful operation of a driver, application or service. Basically, a service is calling home.
- **Warning:** Describes an event that may not be a present issue but can cause problems in the future.
- **Error:** Describes a significant problem with a service or application.
- **Success Audit:** Outlines that an audited security access operation was successful. For example, a user’s successful login to the system.
- **Failure Audit:** Outlines that an audited security access operation failed. For example, a failed access to a network drive by a user.

Windows logs are placed under different categories, with three major ones used for system troubleshooting and investigations:

- **Application:** Records log events associated with system components such as drivers and interface components that run an app.
- **System:** Records events related to programs installed and running on the system.
- **Security:** Records events associated with security, such as logon attempts and resource access.

---

# Aurora

Using Sigma rules this EDR will audit or prevent events it triggers on which will display in Win Event Log Viewer or use code at [Sysmon: See Final Code](https://heckintechin.tech/posts/Sysmon-Install-Guide/) and update XPath and read from local host instead of calling the file. 

On-Prem Solution, enterprise or community version called Aurora Lite. 


|Aurora|Aurora Lite|
|---|---|
|Sigma-based event matching on ETW data|Sigma-based event matching on ETW data|
|An open-source rule set (1300+ rules)|An open-source rule set (1300+ rules)|
|Nextron’s Sigma rule set|No Nextron’s Sigma rule set|
|Open-source IOC set|Open-source IOC set|
|Nextron’s IOC set|No Nextron’s IOC set|
|Alert output channels: Eventlog, File, UDP/TCP|Alert output channels: Eventlog, File, UDP/TCP|
|Comfortable management with ASGARD|-|
|Additional detection modules|-|
|Unlimited number of response actions|-|
|Rule encryption|-|

Features source: [Nextron Systems - Aurora](https://www.nextron-systems.com/aurora/)

Aurora obtains data from different ETW channels and adds live information (for the commercial version) to enrich and recreate events similar to those generated by Sysmon. It does not create tons of logs; it only populates the viewer with events of triggered rules. Below, we can look at a comparison between Aurora and Sysmon.

|Aurora|Sysmon|
|---|---|---|
|Event Source|Event Tracing for Windows (ETW)|Sysmon Kernel Driver.|
|Sigma Rule Event Coverage|95%|100%|
|Relative Log Volume|Low|High|
|Sigma & IOC Matching|Yes|No|
|Response Actions|Yes|No|
|Resource Control (CPU Load, Output Throttling)|Yes|No|
|Output: Eventlog|Yes|Yes|
|Output: File|Yes|No|
|Output: TCP/UDP Target|Yes|No|
|Risk: Incomplete Data due to Filters|No|Yes|
|Risk: Blue Screen|No|Yes|
|Risk: High System Load|No|Yes|

Aurora is supported on Windows 7/ Windows Server 2012 or newer versions and must run using administrator privileges. It must also be excluded from any running antivirus or EDR solutions. This is to avoid the application being blocked from executing its services.

Look at how to install and configure Aurora correctly via the [User Manual](https://aurora-agent-manual.nextron-systems.com/en/latest/index.html).


## Aurora Presets

Aurora can be configured to use four different configuration formats that dictate how the solution would fetch events and raise alerts. The four preset formats are:

- **Standard:** This configuration covers events at a medium level of severity.
- **Reduced:** This configuration looks at events considered to be at a high minimum reporting level.
- **Minimal:** This configuration looks at events considered to be at a high minimum reporting level.
- **Intense:** This configuration looks at events considered to be at a low minimum reporting level.

|Affected Setting|Standard|Reduced|Minimal|Intense|
|---|---|---|---|---|
|Deactivated sources|Registry, Raw Disk Access, Kernel Handles, Create Remote Thread|Registry, Raw Disk Access, Process Access|Registry, Raw Disk Access, Kernel Handles, Create Remote Thread, Process Access, Image Loads|-|
|CPU Limit|35%|30%|20%|100%|
|Process Priority|Normal|Normal|Low|Normal|
|Minimum Reporting Level|Medium|High|High|Low|
|Deactivated Modules|-|LSASS Dump Detector|LSASS Dump Detector, BeaconHunter|-|

## Running Aurora

Run a perfered configuration
```powershell
C:\Program Files\Aurora-Agent>aurora-agent.exe -c agent-config-minimal.yml
```

Run as a service

```powershell
C:\Program Files\Aurora-Agent>aurora-agent.exe -c agent-config-minimal.yml
```

Query Flags

`–status: Queries status information from the currently running service.`

`- **–trace:** Queries all the events Aurora monitors from the subscribed channels. It also provides complete event statistics.`

`- **–json:** Outputs information in JSON format for a more comprehensive view of the alerts that are easy to search.`

## Outputs

Windows EventLog: Source Application Source AuroraAgent

`- **Log File:** A log file can be written using the `--logfile` flag, which will be automatically rotated once the specified log size has been attained (by default, this is 10MB). The log files would be found under the directory where Aurora is running from.`

```powershell
C:\Program Files\Aurora-Agent>aurora-agent.exe --logfile aurora-minimal.log
```

Point it somewhere

`UDP/TCP Targets`: Network targets direct Aurora events to an internal repository via UDP or TCP using the flags `--udp-target` and `--tcp-target`. These options require arguments in the form of `host: port`, such as `internal.repo:8443`.

## Aurora Responses  

Responses extend the Sigma services and can be used to set specific actions to be performed and respond when an event matches. These actions can help contain a threat actor or limit their damage to the system host. The intended use cases for the responses are **worm containment, ransomware containment, and the hard blocking of applications.**

Aurora supports two responses: **Predefined** and **Custom.**

### Predefined Responses

The following responses are available by default with the installation of Aurora:

- **Suspend:** Used to stop a specified process.
- **Kill:** Used to kill a specified process.
- **Dump:** Used to create a dump file found in the `dump-path` folder.

### Custom Responses

Custom responses are meant to call an internal program to execute a function based on a raised alert. The program has to be available from `PATH` and the answer would be a command-line query.

With these responses, a set of flags can be used to modify and relay different types of information. The flags have been summarised in the table below:

|Flag|Definition|
|---|---|
|Simulate|Used to test out rules, and responses that won't be triggered. A log will be created to indicate the type of response that would be triggered.|
|Recursive|It is used to specify that the response will affect descendent processes. It is usually `true` by default.|
|Low privilege only|Marked by the flag `lowprivonly.` The flag specifies that the response will be triggered if the target process does not run as `LOCAL SYSTEM` or at an elevated role.|
|Ancestor|The `ancestors` flag specifies that the response will affect a process’s ancestor, not itself. The key: value pair is indicated by integers to show the level of ancestors, e.g. one (1) is for parent process, 2 for grand-parent, and so on.|
|Process ID field|The `processidfield` flag specifies the field contains the process ID that shall be affected by the response.|

### Kill Parent Process Response

```powershell
response:
    type: predefined
    action: kill
    processidfield: ParentProcessId
```

### Aurora Suspend Response

```powershell
response:
    type: predefined
    action: suspend
```


### Copy Image to backup folder custom response

```powershell
response:
    type: custom
    action: cmd /c copy %Image% "%%ProgramData%%\Aurora\Image-%ProcessId%.bin"
```

## Aurora Event IDs

If you may have noticed through the screenshots and navigating through the VM, Aurora uses event IDs to log to the Windows Eventlog. The tables below list the IDs related to Sigma, internal and other notable modules used.

| Event ID | Description                                                                      | Event ID | Description                                 |     |
| -------- | -------------------------------------------------------------------------------- | -------- | ------------------------------------------- | --- |
| 1        | A process creation Sigma rule matched.                                           | 100      | A license file was found.                   |     |
| 2        | A set file creation time sigma rule matched.                                     | 101      | Status message (from --report-stats)        |     |
| 3        | A network connection sigma rule matched.                                         | 102      | Aurora Agent started.                       |     |
| 4        | A sysmon status Sigma rule matched.                                              | 103      | Aurora Agent is terminating.                |     |
| 5        | A process termination Sigma rule matched.                                        | 104      | The current license expired.                |     |
| 6        | A driver-loaded Sigma rule matched.                                              | 105      | No valid license file was found.            |     |
| 7        | An image-loaded Sigma rule matched.                                              | 107      | A process created a large number of events. |     |
| 8        | A create remote thread Sigma rule matched.                                       | 108      | An internal panic occurred.                 |     |
| 9        | A raw disk access Sigma rule matched.                                            | 200      | BeaconHunter                                |     |
| 10       | A process access Sigma rule matched.                                             | 300      | Lsass Dump Detector                         |     |
| 11       | A file creation Sigma rule matched.                                              | 400      | ETW Canary                                  |     |
| 12       | A registry event Sigma rule matched.                                             | 500      | Process Tampering Detector                  |     |
| 15       | A create stream hash Sigma rule matched.                                         | 600      | Temporary Driver Load Detector              |     |
| 17       | A pipe event Sigma rule matched.                                                 | 700      | Command Line Mismatch Detector              |     |
| 19       | A WMI event Sigma rule matched.                                                  | 800      | Event Distributor                           |     |
| 21       | A registry event Sigma rule matched.                                             | 900      | ETW Provider                                |     |
| 22       | A DNS query Sigma rule matched.                                                  | 1000     | Eventlog Provider                           |     |
| 23       | A file deletion Sigma rule matched.                                              | 1100     | Handle Polling Provider                     |     |
| 99       | Another Sigma rule (that did not belong to one of the above categories) matched. | 1200     | Resource Control                            |     |
| 98       | Unspecified log message from Sigma module.                                       |          |                                             |     |
| 97       | No Sigma rule files were found.                                                  |          |                                             |     |
| 96       | Sigma rules were reloaded.                                                       |          |                                             |     |
| 95       | An error occurred while loading the Sigma rules.                                 |          |                                             |     |
| 6000     | A response for a sigma match was executed.                                       |          |                                             |     |
| 6001     | A response for a sigma match was simulated.                                      |          |                                             |     |

---

## Function Tests

- **Listing user account privileges:** Running a simple command `whoami /priv` to list the current user privileges will trigger a Sigma rule with a level **high** and create a `WARNING` level message on the Eventlog. This will be a process creation alert.
- **Suspicious network communication:** Running a suspicious DNS beaconing request will result in a critical rule being triggered. Below is an example that matches a suspicious cobalt strike DNS beaconing.

---

## Detection Gaps

## Named Pipes

Named pipes are a one-way communication channel between processes that are subject to security checks in the memory. ETW has no provider to gather information about the creation or connection to named pipes. Observing named pipe events is through the Kernel Object Handle, which is noisy and can provide unnecessary information.

### Solution

- Using Aurora under “Intense” configurations.
- Complement Aurora configuration with Sysmon to capture the events.

## Registry Events

Registry events are generated on the ETW by creating keys or writing values, primarily via the `Microsoft-Windows-Kernel-Registry.` However, this information may not be directly usable as all registry handles must be tracked individually as keys are referenced by their handle. For value setting too,

### Solution

- Using Aurora under “Intense” configurations.
- Complement Aurora configuration with Sysmon to capture the events.

## ETW Disabled

Attackers have the ability to disable ETW events by patching the system calls that Windows would use to create the events from user space. Writing detection rules based on events that originate from the process and are caused by a provider that is not `Microsoft-Windows-Kernel` should be done with care.

### Solution

- Aurora’s full version uses the ETW Canary module to detect any manipulations of ETW.
- Using the flag `--report-stats` allows for reporting the agent’s status to your SIEM and will include stats of the observed, processed and dropped events that can indicate signs of manipulations.

## Create Custom View

Open Event Viewer > Click on all logging levels > Click on source scroll down to select only aurora agent > Create View > Refresh to view


